<%- include('../Client/partials/header'); -%>

<head>
  <link rel="stylesheet" href="../../../assets/styles/maincopia.css" />
</head>

<body id="page-top" onload="loadChat();">
  <!-- Page Wrapper -->
  <div id="wrapper">
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">
        <%- include('./partials/nav'); -%>

        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4" style="margin: 50px 0 0px 0;">
            <a class="fas fa-arrow-left" style="width: auto !important;" href="/client"><p style="font-family: Quicksand; display: inline-block;">&nbsp&nbsp Volver a inicio </p></a></div>

      <!-- Content Row -->
      <div class="row">
        <div class="col-xl col-lg">
          <div class="card shadow mb-4">
            <!-- Card Body -->
            <div class="card-body">
              <div class="row no-gutters">
                <div class="col">
                  <img src="https://picsum.photos/500.webp" class="card-img rounded2" alt="..." style="width: 100%; height: 100%;">
                </div>
                <div class="col-md-8 col-8 col-sm-8">
                  <div class="card-body" style="padding: 1.25rem !important;">
                    <h5 class="card-title breakpoint_font" style="font-weight: bold; font-stretch: normal; font-style: normal; line-height: 1.43; letter-spacing: normal; color: #2a2a35;"><%= notice.name %></h5>
                    <p class="card-text" style="font-weight: normal; font-stretch: normal; font-style: normal; line-height: 1.14; letter-spacing: normal; color: #2a2a35;">Por <%= user.firstname %> <%= user.lastname %></p>
                    <!-- <a href="" class="btn btn-outline-primary style_btn mb-2 mb-md-0" style="font-size: .7rem;"></a>
                    <a href="" class="btn btn-outline-primary style_btn" style="font-size: .7rem;"></a> -->
                  </div>
                </div>
              </div>
              <br><br>
              <h6 class="col" style="font-weight: bold; color: #2a2a35;">Descripión</h6>
              <p class="col"><%= notice.description %></p>
              <ul id="progressbar" style="margin: 0; padding: 0; list-style:none;" class="col">

                <li style="margin: 20px 0;">
                  <a class="fas fa-check user_style" style="display: inline;"
                  ><p style="font-family: Quicksand; display: inline-block; color: #2a2a35;">
                    &nbsp;&nbsp; Propuesta creada el:
                  </p>
                  <p
                  style="
                  font-family: Quicksand;
                  display: inline-block;
                  color: #2a2a35;
                  font-weight: normal;
                  "
                  >
                  &nbsp;<%= moment(notice.timeStampCreate).format("DD/MM/YYYY") %>
                </p></a
                >
              </li>
              <li style="margin: 20px 0;">
                <a class="fas fa-briefcase user_style" style="display: inline;"
                ><p style="font-family: Quicksand; display: inline-block; color: #2a2a35;">
                  &nbsp;&nbsp; Tiempo de trabajo:
                </p>
                <p
                style="
                font-family: Quicksand;
                display: inline-block;
                color: #2a2a35;
                font-weight: normal;
                "
                >
                &nbsp;<%= notice.estimatedTime %> <%=
                notice.estimatedUnit %>
              </p></a
              >
            </li>

          <li style="margin: 20px 0;">
            <a class="fas fa-money-bill-wave user_style-money" style="display: inline;"
            ><p style="font-family: Quicksand; display: inline-block; color: #2a2a35;">
              &nbsp;&nbsp; Precio:
            </p>
            <p
            style="
            font-family: Quicksand;
            display: inline-block;
            color: #2a2a35;
            font-weight: normal;
            "
            >
            &nbsp;$<%= notice.price %>
          </p></a
          >
        </li>



      </ul>
      <%if (requirement.length>0){%>
        <a href="/partner/opportunity/<%= requirement[0]._id%>" class="btn btn-block btn-primary px-4 label_style2" style="font-weight: normal; width: 100%; margin-top: 50px; ">Ver Requerimiento</a>
      <%}%>
        </div>
      </div>
    </div>



    <div class="col-xl col-lg">
      <div class="card shadow mb-4" style="padding: 0;">
        <!-- Card Body -->
        <div class="card-body" style="padding: 0;">
          <div class="col" style="padding: 0;">
            <div class="settings-tray">
              <div class="friend-drawer no-gutters friend-drawer--grey">
                <img class="profile-image" src="<%= cliente.photo %>" onerror = 'this.src="https://st4.depositphotos.com/1000507/24026/v/450/depositphotos_240260608-stock-illustration-robocop-simple-abstract-vector-illustration.jpg"' alt="">
                <div class="text">
                  <h6><%= cliente.firstname%> <%= cliente.lastname %></h6>
                  <p id="lastLogin" class="text-muted">
                    <% if (cliente.lastLogin){ %>
                      <%= moment(cliente.lastLogin).local().format("DD/MM/YYYY hh:mm a") %>
                      <%} else {%>
                        Offline
                        <%}%>
                      </p>
                    </div>
                  </div>
                </div>
                <hr style="margin: 0 auto;">
                <div class="text-center">
                  <!-- <button class="btn btn-info" style="  border-radius: 18px; background-color: #f4f4ff; border: #f4f4ff; color: #000; font-weight: lighter;">AYER</button> -->
                </div>
                <div class="chat-panel" style="max-height: 50vh;overflow-y: scroll;" id="chat_panel">

    </div>
    <div class="row">
      <div class="col-12">
        <div class="chat-box-tray">
          <!-- <i class="fas fa-paperclip"></i> -->

          <i class="fa">&nbsp;</i>
          <input id="chat_message"type="text" placeholder="Escribe tu mensaje…" />
          <i id="send_message" class="fas fa-paper-plane" onclick="sendMessage()"></i>

        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>

</div>
<!-- /.container-fluid -->


</div>
<!-- End of Main Content -->

<!-- Footer -->
<%- include('./partials/footer'); -%>
<!-- End of Footer -->
</div>
<!-- End of Content Wrapper -->

<%- include('./partials/sidebar'); -%>
</div>
</body>

<%- include('../Client/partials/requirement/sub-footer'); -%>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

const socket = io();

socket.on('private-message-notice', (data) => {

     if (data.message!=""){

     var div_row = $("<div>").attr("class","row no-gutters").appendTo('#chat_panel');
       if (data.me){
         var div_col = $("<div>").attr("class","col-md offset-md-3 offset-sm-3 offset-3").appendTo(div_row);
         var div_chat = $("<div>").attr("class","chat-bubble chat-bubble--right").append(data.message).appendTo(div_col);
       } else {
         var div_col = $("<div>").attr("class","col-md-9 col-sm-9 col-9").appendTo(div_row);
         var div_chat = $("<div>").attr("class","chat-bubble chat-bubble--left").append(data.message).appendTo(div_col);
       }
     var p_text = $("<p>").attr("style","float: right; font-size: 10px; margin-top: 15px; color: #e97676;").append(moment(data.time).format("hh:mm a")).appendTo(div_chat);
     $("#lastLogin").html(data.lastLogin);
     }
   scrollSmoothToBottom()
})

socket.on('chat_disconnect', (data) => {
  $("#lastLogin").html(moment().format("DD/MM/YYYY hh:mm a"));
})

// Execute a function when the user releases a key on the keyboard
$('#chat_message').on("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    $("#send_message").click();
  }
});

function sendMessage(){
  var message = $('#chat_message').val();
  var data = {
    message,
    isPartner: true,
    id: socket.id,
    cliente: <%- JSON.stringify(cliente._id) %>,
    user: <%- JSON.stringify(user._id) %>,
    notice: <%- JSON.stringify(notice._id) %>
  }
  socket.emit('private-message-notice', data, (error) => {
     if (error) {
       console.log(error);
     }
  })
  $('#chat_message').val('');
  scrollSmoothToBottom()
}



function identifyUser(){

  var data = {
    message:"",
    isPartner: true,
    id: socket.id,
    cliente: <%- JSON.stringify(cliente._id) %>,
    user: <%- JSON.stringify(user._id) %>,
    notice: <%- JSON.stringify(notice._id) %>
  }
  socket.emit('private-message-notice', data, (error) => {
     if (error) {
       console.log(error);
     }
  })

}

function loadChat(){
    identifyUser();
    var talk =  <%- JSON.stringify(chat) %> || [];
    var partner = <%- JSON.stringify(user) %>;

    talk.chat.forEach(function(c){

      var div_row = $("<div>").attr("class","row no-gutters").appendTo('#chat_panel');
        if (String(c.user) == String(partner._id)){
          var div_col = $("<div>").attr("class","col-md offset-md-3 offset-sm-3 offset-3").appendTo(div_row);
          var div_chat = $("<div>").attr("class","chat-bubble chat-bubble--right").append(c.message).appendTo(div_col);
        } else {
          var div_col = $("<div>").attr("class","col-md-9 col-sm-9 col-9").appendTo(div_row);
          var div_chat = $("<div>").attr("class","chat-bubble chat-bubble--left").append(c.message).appendTo(div_col);
        }
      var p_text = $("<p>").attr("style","float: right; font-size: 10px; margin-top: 15px; color: #e97676;").append(moment(c.time).format("hh:mm a")).appendTo(div_chat);
    })
    scrollSmoothToBottom()
}

function scrollSmoothToBottom() {
   var div = document.getElementById("chat_panel");
   $('#chat_panel').animate({
      scrollTop: div.scrollHeight - div.clientHeight
   }, 500);
}


</script>
